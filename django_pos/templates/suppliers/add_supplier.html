{%extends 'pos/base.html'%}
{% load static %}
{% block title %}Add New Supplier{% endblock %}
{%block heading%}
<div class="d-flex align-items-center">
    <i class="ti ti-truck-delivery me-2 text-primary"></i>
    <span>Add New Supplier</span>
</div>
{%endblock%}
{% block content %}

<!-- Header Section with Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm bg-gradient-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title text-white mb-1">
                            <i class="ti ti-truck-delivery me-2"></i>
                            New Supplier Registration
                        </h4>
                        <p class="card-text text-white-50 mb-0">Add a new supplier to your business network</p>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <a href="{% url 'suppliers:index' %}" class="btn btn-light btn-lg shadow-sm">
                            <i class="ti ti-arrow-left me-1"></i>
                            Back to Suppliers
                        </a>
                        <a href="{% url 'customers:customers_list' %}" class="btn btn-outline-light btn-lg">
                            <i class="ti ti-file-upload me-1"></i>
                            Import Suppliers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Form Section -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 48px; height: 48px;">
                            <i class="ti ti-building-store fs-5"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Supplier Information</h5>
                        <p class="text-muted mb-0">Enter the supplier's details below</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <form action="/suppliers/api/" method="post" id="supplier_form" enctype="text/plain" novalidate>
                    {% csrf_token %}

                    <!-- Basic Information Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="ti ti-info-circle me-2"></i>
                            Basic Information
                        </h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="name" class="form-label fw-semibold">
                                    <i class="ti ti-building-store me-1 text-primary"></i>
                                    Supplier Name <span class="text-danger">*</span>
                                </label>
                                <input id="name" type="text" class="form-control form-control-lg" name="name"
                                    placeholder="e.g., Bakari Suppliers Limited" required>
                                <div class="invalid-feedback">
                                    Please provide a valid supplier name.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="ti ti-address-book me-2"></i>
                            Contact Information
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label fw-semibold">
                                    <i class="ti ti-mail me-1 text-info"></i>
                                    Email Address
                                </label>
                                <input id="email" type="email" name="email" class="form-control"
                                    placeholder="supplier@company.com">
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label fw-semibold">
                                    <i class="ti ti-phone me-1 text-success"></i>
                                    Phone Number
                                </label>
                                <input id="phone" type="tel" name="phone" class="form-control"
                                    placeholder="+254 712 345 678">
                                <div class="invalid-feedback">
                                    Please provide a valid phone number.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Information Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="ti ti-briefcase me-2"></i>
                            Business Information
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tax_id" class="form-label fw-semibold">
                                    <i class="ti ti-file-text me-1 text-warning"></i>
                                    Tax ID / VAT Number
                                </label>
                                <input id="tax_id" type="text" name="tax_id" class="form-control"
                                    placeholder="P012345678M">
                                <small class="form-text text-muted">Enter the supplier's tax identification
                                    number</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="website" class="form-label fw-semibold">
                                    <i class="ti ti-world me-1 text-info"></i>
                                    Website
                                </label>
                                <input type="url" name="website" id="website" class="form-control"
                                    placeholder="https://www.supplier-website.com">
                                <div class="invalid-feedback">
                                    Please provide a valid website URL.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="ti ti-map-pin me-2"></i>
                            Address Information
                        </h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label fw-semibold">
                                    <i class="ti ti-location me-1 text-danger"></i>
                                    Physical Address
                                </label>
                                <input id="address" type="text" name="address" class="form-control"
                                    placeholder="123 Business Street, Industrial Area, Nairobi">
                                <small class="form-text text-muted">Enter the supplier's complete physical
                                    address</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="ti ti-notes me-2"></i>
                            Additional Information
                        </h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="additional_notes" class="form-label fw-semibold">
                                    <i class="ti ti-message me-1 text-secondary"></i>
                                    Notes & Comments
                                </label>
                                <textarea name="additional_notes" id="additional_notes" class="form-control" rows="4"
                                    placeholder="Enter any additional notes about this supplier (payment terms, special agreements, etc.)"></textarea>
                                <small class="form-text text-muted">Optional: Add any relevant information about this
                                    supplier</small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                        <div>
                            <small class="text-muted">
                                <i class="ti ti-info-circle me-1"></i>
                                Fields marked with <span class="text-danger">*</span> are required
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'suppliers:index' %}" class="btn btn-outline-secondary">
                                <i class="ti ti-x me-1"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-4" id="submit">
                                <i class="ti ti-device-floppy me-1"></i>
                                Save Supplier
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
    }

    .form-control {
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: #5e72e4;
        box-shadow: 0 0 0 0.2rem rgba(94, 114, 228, 0.25);
    }

    .form-control-lg {
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
    }

    .form-label {
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .card {
        transition: all 0.3s ease;
    }

    .btn {
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .invalid-feedback {
        display: block;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .form-control.is-valid {
        border-color: #198754;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.8-.77-.76-.76-.76.76zm1.5-4.47h1.33L3.75 3.61v.77z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .section-header {
        border-left: 4px solid #5e72e4;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        text-align: center;
    }
</style>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 mb-0">Saving supplier...</p>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Form validation patterns
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phonePattern = /^[\+]?[1-9][\d]{0,15}$/;
        const urlPattern = /^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&=]*)$/;

        // Real-time validation
        function validateField(field, pattern = null, required = false) {
            const value = field.val().trim();
            const fieldContainer = field.closest('.mb-3');

            // Remove existing validation classes
            field.removeClass('is-valid is-invalid');

            if (required && !value) {
                field.addClass('is-invalid');
                return false;
            } else if (value && pattern && !pattern.test(value)) {
                field.addClass('is-invalid');
                return false;
            } else if (value || (!required && !value)) {
                if (value) field.addClass('is-valid');
                return true;
            }

            return true;
        }

        // Add real-time validation to fields
        $('#name').on('blur keyup', function () {
            validateField($(this), null, true);
        });

        $('#email').on('blur keyup', function () {
            const value = $(this).val().trim();
            if (value) {
                validateField($(this), emailPattern, false);
            } else {
                $(this).removeClass('is-valid is-invalid');
            }
        });

        $('#phone').on('blur keyup', function () {
            const value = $(this).val().trim();
            if (value) {
                validateField($(this), phonePattern, false);
            } else {
                $(this).removeClass('is-valid is-invalid');
            }
        });

        $('#website').on('blur keyup', function () {
            const value = $(this).val().trim();
            if (value) {
                validateField($(this), urlPattern, false);
            } else {
                $(this).removeClass('is-valid is-invalid');
            }
        });

        // Form submission with enhanced validation
        $('#supplier_form').submit(function (e) {
            e.preventDefault();

            // Validate all fields
            const nameValid = validateField($('#name'), null, true);
            const emailValid = $('#email').val().trim() ? validateField($('#email'), emailPattern, false) : true;
            const phoneValid = $('#phone').val().trim() ? validateField($('#phone'), phonePattern, false) : true;
            const websiteValid = $('#website').val().trim() ? validateField($('#website'), urlPattern, false) : true;

            // Check if form is valid
            if (!nameValid || !emailValid || !phoneValid || !websiteValid) {
                toastr.error('Please correct the errors in the form before submitting.', 'Validation Error', {
                    positionClass: 'toast-top-right',
                    progressBar: true,
                    timeOut: 5000
                });

                // Focus on first invalid field
                $('.is-invalid').first().focus();
                return;
            }

            // Show loading state
            const submitBtn = $('#submit');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html(`
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Saving...
            `);

            // Show loading overlay
            $('#loadingOverlay').show();

            const form = $(this);
            let action = form.attr("action");

            $.ajax({
                method: 'POST',
                url: action,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                data: form.serialize(),
                timeout: 30000, // 30 second timeout
                success: function (response) {
                    // Hide loading
                    $('#loadingOverlay').hide();
                    submitBtn.prop('disabled', false).html(originalText);

                    // Show success message
                    toastr.success('Supplier has been successfully added to your system!', 'Success', {
                        positionClass: 'toast-top-right',
                        progressBar: true,
                        timeOut: 3000,
                        onHidden: function () {
                            // Redirect after toast is hidden
                            window.location.href = "{% url 'suppliers:index' %}";
                        }
                    });

                    // Reset form
                    form.trigger('reset');
                    $('.form-control').removeClass('is-valid is-invalid');
                },
                error: function (xhr, status, error) {
                    // Hide loading
                    $('#loadingOverlay').hide();
                    submitBtn.prop('disabled', false).html(originalText);

                    let errorMessage = 'An unexpected error occurred while adding the supplier.';

                    if (xhr.status === 400) {
                        errorMessage = 'Please check your input data and try again.';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Server error occurred. Please try again later.';
                    } else if (status === 'timeout') {
                        errorMessage = 'Request timed out. Please check your connection and try again.';
                    }

                    toastr.error(errorMessage, 'Error', {
                        positionClass: 'toast-top-right',
                        progressBar: true,
                        timeOut: 5000
                    });

                    console.error('Error:', error);
                }
            });
        });

        // Auto-format phone number
        $('#phone').on('input', function () {
            let value = $(this).val().replace(/\D/g, '');
            if (value.startsWith('254')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+254' + value.substring(1);
            }
            $(this).val(value);
        });

        // Auto-format website URL
        $('#website').on('blur', function () {
            let value = $(this).val().trim();
            if (value && !value.startsWith('http://') && !value.startsWith('https://')) {
                $(this).val('https://' + value);
            }
        });

        // Character counter for notes
        $('#additional_notes').on('input', function () {
            const maxLength = 500;
            const currentLength = $(this).val().length;
            const remaining = maxLength - currentLength;

            let counterElement = $(this).siblings('.char-counter');
            if (counterElement.length === 0) {
                counterElement = $('<small class="char-counter form-text text-muted"></small>');
                $(this).after(counterElement);
            }

            if (remaining < 50) {
                counterElement.removeClass('text-muted').addClass('text-warning');
            } else {
                counterElement.removeClass('text-warning').addClass('text-muted');
            }

            counterElement.text(`${remaining} characters remaining`);

            if (currentLength > maxLength) {
                $(this).val($(this).val().substring(0, maxLength));
            }
        });

        // Add smooth animations
        $('.card').addClass('animate__animated animate__fadeInUp');

        // Focus first field on load
        setTimeout(() => {
            $('#name').focus();
        }, 500);

        // Prevent form submission on Enter key except for submit button
        $(document).on('keypress', 'input:not([type="submit"])', function (e) {
            if (e.which === 13) {
                e.preventDefault();
                const inputs = $('input:visible');
                const nextIndex = inputs.index(this) + 1;
                if (nextIndex < inputs.length) {
                    inputs.eq(nextIndex).focus();
                } else {
                    $('#submit').focus();
                }
            }
        });
    });
</script>
{%endblock content%}