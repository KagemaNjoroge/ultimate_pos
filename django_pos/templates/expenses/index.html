{%extends 'pos/base.html'%}
{% load static %}
{% block title %}Expenses{% endblock %}
{%block heading%}Expenses{%endblock%}
{% block content %}

<div class="mb-3 ml-2">
    <a>
        <button type="button" class="btn btn-success font-weight-bold" id="show_add_expense_modal">
            <i class="ti ti-plus"></i>
            Add Expense
        </button>
    </a>

    <a href="{%url 'expenses:category'%}">
        <button type="button" class="btn btn-secondary font-weight-bold">
            <i class="ti ti-list"></i>
            Expense Categories
        </button>
    </a>
</div>


<div class="card ml-2">
    <div class="card-body">
        <div id="alerts"></div>
        {% if expenses %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover" id="dataTable">
                <thead>
                    <tr>
                        <th>Expense</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>{{expense.expense_name}}</td>
                        <td>{{expense.amount}}</td>
                        <td>{{expense.date_added}}</td>
                        <td>{{expense.category}}</td>
                        <td>
                            <button class="btn btn-primary edit" data-id="{{expense.id}}"
                                data-name="{{expense.expense_name}}" data-amount="{{expense.amount}}"
                                data-category="{{expense.category}}" data-description="{{expense.expense_description}}">
                                <i class="ti ti-pencil"></i>
                            </button>
                            <button class="btn btn-danger delete" data-id="{{expense.id}}"
                                data-name="{{expense.expense_name}}">

                                <i class="ti ti-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No expenses found</p>
        {% endif %}


    </div>
</div>
<script>
    $(document).ready(function () {
        $('#dataTable').on('click', '.edit', function () {
            let id = $(this).data('id');
            let name = $(this).data('name');
            let amount = $(this).data('amount');
            let category = $(this).data('category');
            let description = $(this).data('description');
            $('#editExpenseModal').modal('show');
            $('#name').val(name);
            $('#amount_').val(amount);
            $('#category_').val(category);
            $('#description_').val(description);
            $('#id').val(id);


        });
        $('#edit_expense_form').submit(function (e) {
            e.preventDefault();
            $('#save_edit_expense').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            var id = $('#id').val();
            console.log($(this).serialize())
            $.ajax({
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                url: `?id=${id}`,

                data: JSON.stringify({
                    "description": $('#description_').val(),
                    "amount": $('#amount_').val(),
                    "category": $('#category_').val(),
                    "name": $('#name').val()


                }),
                success: function (response) {

                    if (response['status'] == 'success') {
                        $('#editExpenseModal').modal('hide');
                        // clear form fields
                        $('#edit_expense_form').trigger('reset');
                        // show success alert
                        $('#alerts').html(
                            `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Sucsess:</strong> Expense <strong>${response.expense.expense_name}</strong> updated successfully.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                            `

                        )
                        //reload in 2 seconds
                        setTimeout(() => {
                            location.reload();

                        }, 2000);

                    }
                    else if (response['status'] == 'error') {
                        $('#edit_expense_form').trigger('reset');
                        $('#alerts').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> ${response['error']}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        `);
                    }
                    else {
                        $('#alerts').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> An error occurred. Please try again later.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        `);
                    }
                }
            }).done(function () {
                $('#save_edit_expense').html('Save');
            });
        });
        let tblCategories = $('#dataTable').DataTable({
            "order": [
                [2, "desc"]
            ]
        })
        $('#show_add_expense_modal').click(function () {
            $('#addExpenseModal').modal('show');
        });
        $('.close_add_expense').click(function () {
            $('#addExpenseModal').modal('hide');
        });
        $('.close_edit_expense').click(function () {
            $('#editExpenseModal').modal('hide');
        });
        $('#dataTable').on('click', '.delete', function () {
            let id = $(this).data('id');
            let name = $(this).data('name');
            $('#deleteExpenseModal').modal('show');
            $('#expense_name_').html(name);
            $('#expense_id_').val(id);
        });
        $('.close_delete').click(function () {
            $('#deleteExpenseModal').modal('hide');
        });
        $('#delete_expense').click(function () {
            let id = $('#expense_id_').val();
            // show spinner
            $('#delete_expense').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
            $.ajax({
                type: 'DELETE',
                url: `?id=${id}`,
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function (response) {
                    if (response['status'] == 'success') {
                        $('#deleteExpenseModal').modal('hide');
                        // show success alert
                        $('#alerts').html(
                            `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Sucsess:</strong> Expense  deleted successfully.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                            `

                        )
                        //reload in 2 seconds
                        setTimeout(() => {
                            location.reload();

                        }, 2000);
                    }
                    else {
                        $('#alerts').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> An error occurred. Please try again later.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        `);
                    }
                }
            });
        });
        $('#expense_form').submit(function (e) {
            e.preventDefault();
            $('#save_expense').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

            $.ajax({
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                url: '',
                processData: false,
                contentType: "application/json",
                data: JSON.stringify(
                    {
                        "expense_name": $('#expense_name').val(),
                        "amount": $('#amount').val(),
                        "description": $('#description').val(),
                        "category": $('#category').val()
                    }
                ),
                success: function (response) {

                    if (response['status'] == 'success') {
                        $('#addExpenseModal').modal('hide');
                        // clear form fields
                        $('#expense_form').trigger('reset');
                        // show success alert

                        // reload in 2 seconds
                        setTimeout(() => {
                            $('#alerts').html(
                                `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Sucsess:</strong> Expense <strong>${response.expense.expense_name}</strong> added successfully.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                            `

                            )
                            location.reload();

                        }, 2000);

                    }
                    else if (response['status'] == 'error') {
                        $('#expense_form').trigger('reset');
                        $('#alerts').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> ${response['error']}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        `);
                    }
                    else {
                        $('#alerts').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> An error occurred. Please try again later.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        `);
                    }
                }
            }).done(function () {
                $('#save_expense').html('Save');
            });
        });
    });
</script>
{%endblock content%}